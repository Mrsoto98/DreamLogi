import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, serverTimestamp } from 'firebase/firestore';

// Importa los iconos de Lucide React
import { Home, PlusCircle, Users, Sparkles, Brain, LogOut, UserPlus, Trash2, Eye, EyeOff, Lightbulb, Tag } from 'lucide-react';

// Contexto para la autenticaci√≥n y la base de datos
const AppContext = createContext();

// Componente de mensaje modal personalizado
const MessageBox = ({ message, onConfirm, onCancel, showCancel = false }) => {
  if (!message) return null;

  return (
    <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 animate-fade-in">
      <div className="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center transform scale-95 animate-scale-in border-t-4 border-blue-500">
        <p className="text-xl mb-6 text-gray-800 font-semibold">{message}</p>
        <div className="flex justify-center space-x-4">
          <button
            onClick={onConfirm}
            className="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out transform hover:scale-105"
          >
            Aceptar
          </button>
          {showCancel && (
            <button
              onClick={onCancel}
              className="px-8 py-3 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 transition duration-300 ease-in-out transform hover:scale-105"
            >
              Cancelar
            </button>
          )}
        </div>
      </div>
    </div>
  );
};

// Componente de spinner de carga
const LoadingSpinner = () => (
  <div className="flex justify-center items-center py-8">
    <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500"></div>
  </div>
);

// Componente principal de la aplicaci√≥n
const App = () => {
  const [firebaseApp, setFirebaseApp] = useState(null);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [currentUser, setCurrentUser] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [currentPage, setCurrentPage] = useState('my-dreams'); // Controla la p√°gina actual
  const [messageBox, setMessageBox] = useState({ message: '', onConfirm: null, onCancel: null, showCancel: false });

  // Variables globales de Firebase (proporcionadas por el entorno Canvas)
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  // Inicializaci√≥n de Firebase y gesti√≥n de autenticaci√≥n
  useEffect(() => {
    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const firebaseAuth = getAuth(app);

      setFirebaseApp(app);
      setDb(firestore);
      setAuth(firebaseAuth);

      const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
        if (user) {
          setCurrentUser(user);
          setUserId(user.uid);
        }
        setIsAuthReady(true);
      });

      return () => unsubscribe();
    } catch (error) {
      console.error("Failed to initialize Firebase:", error);
      showMessageBox("Error al inicializar Firebase: " + error.message);
    }
  }, []);

  // Funci√≥n para mostrar el cuadro de mensaje
  const showMessageBox = (message, onConfirm = () => setMessageBox({ message: '' }), onCancel = () => setMessageBox({ message: '' }), showCancel = false) => {
    setMessageBox({ message, onConfirm, onCancel, showCancel });
  };

  const handleGoogleSignIn = async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      showMessageBox("Sesi√≥n iniciada con Google correctamente.");
    } catch (error) {
      console.error("Error al iniciar sesi√≥n con Google:", error);
      if (error.code === 'auth/unauthorized-domain') {
        showMessageBox(
          "Error de autenticaci√≥n: Dominio no autorizado. Por favor, a√±ade el dominio actual a la lista de dominios autorizados en la Consola de Firebase (Autenticaci√≥n > Configuraci√≥n > Dominios autorizados). El dominio a a√±adir es: " + window.location.hostname
        );
      } else {
        showMessageBox("Error al iniciar sesi√≥n con Google: " + error.message);
      }
    }
  };

  const handleSignOut = async () => {
    try {
      await signOut(auth);
      showMessageBox("Sesi√≥n cerrada correctamente.");
      setCurrentUser(null);
      setUserId(null);
    } catch (error) {
      console.error("Error al cerrar sesi√≥n:", error);
      showMessageBox("Error al cerrar sesi√≥n: " + error.message);
    }
  };

  if (!isAuthReady) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-purple-200 to-indigo-300 text-gray-800">
        <LoadingSpinner />
        <p className="mt-4 text-xl font-semibold">Cargando aplicaci√≥n...</p>
      </div>
    );
  }

  // Si no hay usuario autenticado, mostrar la pantalla de inicio de sesi√≥n
  if (!currentUser) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-purple-200 to-indigo-300 text-gray-800 p-4">
        <div className="bg-white p-10 rounded-xl shadow-2xl text-center max-w-lg w-full transform transition-all duration-500 ease-in-out hover:scale-105">
          <h2 className="text-4xl font-extrabold text-purple-700 mb-6">Bienvenido a DreamLog</h2>
          <p className="text-lg text-gray-700 mb-8">
            Publica, comparte y analiza tus sue√±os. Con√©ctate con amigos y descubre coincidencias.
          </p>
          <button
            onClick={handleGoogleSignIn}
            className="flex items-center justify-center w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out transform hover:-translate-y-1"
          >
            <svg className="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12.24 10.285V11.69h4.225c-.244 1.258-1.594 3.033-4.225 3.033-2.54 0-4.604-2.07-4.604-4.61s2.063-4.61 4.604-4.61c1.354 0 2.238.572 2.75 1.06l1.173-1.12c-.93-1.004-2.34-1.61-3.923-1.61-3.387 0-6.14 2.753-6.14 6.14s2.753 6.14 6.14 6.14c3.47 0 5.86-2.46 5.86-5.926 0-.58-.06-1.14-.158-1.68h-5.705z"/>
            </svg>
            Iniciar sesi√≥n con Google
          </button>
        </div>
        <MessageBox {...messageBox} />
      </div>
    );
  }

  const contextValue = {
    db,
    auth,
    currentUser,
    userId,
    appId,
    showMessageBox,
    handleSignOut
  };

  return (
    <AppContext.Provider value={contextValue}>
      <div className="min-h-screen bg-gradient-to-br from-purple-100 to-indigo-200 font-inter text-gray-800">
        <NavBar setCurrentPage={setCurrentPage} />
        <MessageBox {...messageBox} />
        <main className="container mx-auto p-4 md:p-8">
          {/* Contenido de la p√°gina actual */}
          {currentPage === 'my-dreams' && <MyDreams />}
          {currentPage === 'post-dream' && <PostDreamForm />}
          {currentPage === 'friends' && <Friends />}
          {currentPage === 'coincidences' && <Coincidences />}
          {currentPage === 'ai-analysis' && <AIDreamAnalysis />}
        </main>
      </div>
    </AppContext.Provider>
  );
};

// Componente de barra de navegaci√≥n
const NavBar = ({ setCurrentPage }) => {
  const { currentUser, userId, handleSignOut } = useContext(AppContext);

  const NavButton = ({ icon: Icon, label, page }) => (
    <button
      onClick={() => setCurrentPage(page)}
      className="flex items-center space-x-2 px-4 py-2 rounded-full text-gray-700 hover:bg-purple-100 hover:text-purple-700 transition duration-200 ease-in-out group"
    >
      <Icon className="w-5 h-5 text-purple-500 group-hover:text-purple-700 transition-colors duration-200" />
      <span className="font-medium">{label}</span>
    </button>
  );

  return (
    <nav className="bg-white shadow-lg p-4 rounded-b-xl sticky top-0 z-40">
      <div className="container mx-auto flex flex-col md:flex-row justify-between items-center">
        <h1 className="text-4xl font-extrabold text-purple-800 mb-4 md:mb-0 transform transition-transform duration-300 hover:scale-105">
          DreamLog
        </h1>
        <div className="flex flex-wrap justify-center md:justify-end items-center space-x-2 md:space-x-4">
          <NavButton icon={Home} label="Mis Sue√±os" page="my-dreams" />
          <NavButton icon={PlusCircle} label="Publicar Sue√±o" page="post-dream" />
          <NavButton icon={Users} label="Amigos" page="friends" />
          <NavButton icon={Sparkles} label="Coincidencias" page="coincidences" />
          <NavButton icon={Brain} label="An√°lisis IA" page="ai-analysis" />
          {currentUser && (
            <div className="flex items-center space-x-3 ml-4 bg-purple-50 px-4 py-2 rounded-full shadow-inner">
              <span className="text-sm text-gray-600 font-mono hidden sm:inline">ID: {userId.substring(0, 8)}...</span>
              <button
                onClick={handleSignOut}
                className="flex items-center space-x-2 px-4 py-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition duration-300 ease-in-out transform hover:scale-105"
              >
                <LogOut className="w-5 h-5" />
                <span className="font-semibold">Salir</span>
              </button>
            </div>
          )}
        </div>
      </div>
    </nav>
  );
};

// Componente para publicar un nuevo sue√±o
const PostDreamForm = () => {
  const { db, userId, showMessageBox, appId } = useContext(AppContext);
  const [dreamContent, setDreamContent] = useState('');
  const [dreamTitle, setDreamTitle] = useState(''); // Nuevo estado para el t√≠tulo
  const [emotion, setEmotion] = useState('neutral');
  const [isPublic, setIsPublic] = useState(true);
  const [loading, setLoading] = useState(false);
  const [titleLoading, setTitleLoading] = useState(false); // Estado para la carga del t√≠tulo
  const [tagsLoading, setTagsLoading] = useState(false); // Estado para la carga de etiquetas
  const [suggestedTags, setSuggestedTags] = useState([]); // Estado para las etiquetas sugeridas
  const [selectedTags, setSelectedTags] = useState([]); // Estado para las etiquetas seleccionadas

  const emotions = [
    { value: 'joy', label: 'Alegr√≠a' },
    { value: 'sadness', label: 'Tristeza' },
    { value: 'fear', label: 'Miedo' },
    { value: 'anger', label: 'Ira' },
    { value: 'surprise', label: 'Sorpresa' },
    { value: 'disgust', label: 'Asco' },
    { value: 'neutral', label: 'Neutral' },
  ];

  const handleGenerateTitle = async () => {
    if (!dreamContent.trim()) {
      showMessageBox("Por favor, escribe el contenido del sue√±o antes de generar un t√≠tulo.");
      return;
    }
    setTitleLoading(true);
    try {
      let chatHistory = [];
      const prompt = `Genera un t√≠tulo muy corto y evocador (m√°ximo 5 palabras) para el siguiente sue√±o. El t√≠tulo debe ser creativo y capturar la esencia del sue√±o. Responde solo con el t√≠tulo.
      Sue√±o: "${dreamContent}"`;
      chatHistory.push({ role: "user", parts: [{ text: prompt }] });

      const payload = { contents: chatHistory };
      const apiKey = "";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const title = result.candidates[0].content.parts[0].text.replace(/"/g, '').trim(); // Limpiar comillas
        setDreamTitle(title);
      } else {
        showMessageBox("No se pudo generar un t√≠tulo. Int√©ntalo de nuevo.");
        console.error("Respuesta inesperada de la IA para t√≠tulo:", result);
      }
    } catch (error) {
      console.error("Error al llamar a la API de IA para t√≠tulo:", error);
      showMessageBox("Error al generar t√≠tulo con IA: " + error.message);
    } finally {
      setTitleLoading(false);
    }
  };

  const handleSuggestTags = async () => {
    if (!dreamContent.trim()) {
      showMessageBox("Por favor, escribe el contenido del sue√±o antes de sugerir etiquetas.");
      return;
    }
    setTagsLoading(true);
    setSuggestedTags([]); // Limpiar sugerencias anteriores
    try {
      let chatHistory = [];
      const prompt = `Genera una lista de 3 a 5 etiquetas (tags) relevantes y concisas para el siguiente sue√±o. Las etiquetas deben ser palabras clave separadas por comas, sin n√∫meros ni caracteres especiales. Responde solo con la lista de etiquetas.
      Sue√±o: "${dreamContent}"`;
      chatHistory.push({ role: "user", parts: [{ text: prompt }] });

      const payload = { contents: chatHistory };
      const apiKey = "";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const tagsString = result.candidates[0].content.parts[0].text;
        const parsedTags = tagsString.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag.length > 0);
        setSuggestedTags(parsedTags);
      } else {
        showMessageBox("No se pudieron sugerir etiquetas. Int√©ntalo de nuevo.");
        console.error("Respuesta inesperada de la IA para etiquetas:", result);
      }
    } catch (error) {
      console.error("Error al llamar a la API de IA para etiquetas:", error);
      showMessageBox("Error al sugerir etiquetas con IA: " + error.message);
    } finally {
      setTagsLoading(false);
    }
  };

  const handleAddTag = (tag) => {
    if (!selectedTags.includes(tag)) {
      setSelectedTags([...selectedTags, tag]);
    }
  };

  const handleRemoveTag = (tagToRemove) => {
    setSelectedTags(selectedTags.filter(tag => tag !== tagToRemove));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!dreamContent.trim()) {
      showMessageBox("El contenido del sue√±o no puede estar vac√≠o.");
      return;
    }
    if (!userId) {
      showMessageBox("Error: Usuario no autenticado.");
      return;
    }

    setLoading(true);
    try {
      const dreamsCollectionRef = collection(db, `artifacts/${appId}/public/data/dreams`);
      await addDoc(dreamsCollectionRef, {
        userId: userId,
        title: dreamTitle || dreamContent.substring(0, 50) + '...', // Usar t√≠tulo generado o un extracto
        content: dreamContent,
        emotion: emotion,
        isPublic: isPublic,
        tags: selectedTags, // Guardar las etiquetas seleccionadas
        timestamp: serverTimestamp()
      });
      setDreamContent('');
      setDreamTitle('');
      setEmotion('neutral');
      setIsPublic(true);
      setSuggestedTags([]);
      setSelectedTags([]);
      showMessageBox("Sue√±o publicado con √©xito!");
    } catch (error) {
      console.error("Error al publicar sue√±o:", error);
      showMessageBox("Error al publicar sue√±o: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="bg-white p-8 rounded-xl shadow-2xl mb-8 border border-purple-200 animate-fade-in-up">
      <h2 className="text-3xl font-bold text-purple-700 mb-8 text-center">Publicar Nuevo Sue√±o</h2>
      <form onSubmit={handleSubmit}>
        <div className="mb-6">
          <label htmlFor="dreamContent" className="block text-gray-700 text-lg font-semibold mb-2">
            ¬øQu√© so√±aste?
          </label>
          <textarea
            id="dreamContent"
            className="shadow-inner appearance-none border border-gray-300 rounded-lg w-full py-4 px-5 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-purple-300 h-40 resize-y transition duration-200"
            placeholder="Describe tu sue√±o aqu√≠ con detalle..."
            value={dreamContent}
            onChange={(e) => setDreamContent(e.target.value)}
            required
          ></textarea>
        </div>

        <div className="mb-6">
          <label htmlFor="dreamTitle" className="block text-gray-700 text-lg font-semibold mb-2">
            T√≠tulo del Sue√±o:
          </label>
          <div className="flex flex-col sm:flex-row gap-3">
            <input
              id="dreamTitle"
              type="text"
              className="shadow-inner appearance-none border border-gray-300 rounded-lg py-3 px-5 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-purple-300 flex-grow transition duration-200"
              placeholder="T√≠tulo (opcional, o generar con IA)"
              value={dreamTitle}
              onChange={(e) => setDreamTitle(e.target.value)}
            />
            <button
              type="button"
              onClick={handleGenerateTitle}
              className="flex items-center justify-center space-x-2 bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-300 ease-in-out transform hover:scale-105"
              disabled={titleLoading || !dreamContent.trim()}
            >
              {titleLoading ? 'Generando...' : 'Generar T√≠tulo ‚ú®'}
              {!titleLoading && <Lightbulb className="w-5 h-5" />}
            </button>
          </div>
        </div>

        <div className="mb-6">
          <label htmlFor="emotion" className="block text-gray-700 text-lg font-semibold mb-2">
            Emoci√≥n principal:
          </label>
          <select
            id="emotion"
            className="shadow-inner border border-gray-300 rounded-lg w-full py-4 px-5 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-200"
            value={emotion}
            onChange={(e) => setEmotion(e.target.value)}
          >
            {emotions.map((emo) => (
              <option key={emo.value} value={emo.value}>
                {emo.label}
              </option>
            ))}
          </select>
        </div>

        <div className="mb-6">
          <label className="block text-gray-700 text-lg font-semibold mb-2">
            Etiquetas (Tags):
          </label>
          <div className="flex flex-wrap gap-2 mb-3">
            {selectedTags.map(tag => (
              <span key={tag} className="flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full shadow-sm">
                #{tag}
                <button type="button" onClick={() => handleRemoveTag(tag)} className="ml-2 text-blue-600 hover:text-blue-800">
                  &times;
                </button>
              </span>
            ))}
          </div>
          <button
            type="button"
            onClick={handleSuggestTags}
            className="flex items-center justify-center space-x-2 bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-4 focus:ring-orange-300 transition duration-300 ease-in-out transform hover:scale-105"
            disabled={tagsLoading || !dreamContent.trim()}
          >
            {tagsLoading ? 'Sugiriendo...' : 'Sugerir Etiquetas ‚ú®'}
            {!tagsLoading && <Tag className="w-5 h-5" />}
          </button>
          {suggestedTags.length > 0 && (
            <div className="mt-4 flex flex-wrap gap-2">
              <span className="text-gray-600 text-sm italic">Sugerencias:</span>
              {suggestedTags.map(tag => (
                <button
                  key={`suggested-${tag}`}
                  type="button"
                  onClick={() => handleAddTag(tag)}
                  className="bg-gray-200 text-gray-800 text-sm px-3 py-1 rounded-full hover:bg-gray-300 transition duration-200"
                >
                  #{tag}
                </button>
              ))}
            </div>
          )}
        </div>


        <div className="mb-8 flex items-center">
          <input
            id="isPublic"
            type="checkbox"
            className="form-checkbox h-6 w-6 text-purple-600 rounded-md border-gray-300 focus:ring-purple-500 transition duration-200"
            checked={isPublic}
            onChange={(e) => setIsPublic(e.target.checked)}
          />
          <label htmlFor="isPublic" className="ml-3 text-gray-700 text-lg font-semibold cursor-pointer">
            Hacer p√∫blico (otros usuarios podr√°n verlo en coincidencias)
          </label>
        </div>

        <button
          type="submit"
          className="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-extrabold py-4 px-8 rounded-lg shadow-xl focus:outline-none focus:ring-4 focus:ring-purple-300 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:-translate-y-1 w-full text-xl"
          disabled={loading}
        >
          {loading ? 'Publicando...' : 'Publicar Sue√±o'}
        </button>
      </form>
    </div>
  );
};

// Componente para mostrar los sue√±os del usuario
const MyDreams = () => {
  const { db, userId, showMessageBox, appId } = useContext(AppContext);
  const [dreams, setDreams] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!db || !userId) return;

    setLoading(true);
    const dreamsCollectionRef = collection(db, `artifacts/${appId}/public/data/dreams`);
    // Query para obtener solo los sue√±os del usuario actual
    const q = query(dreamsCollectionRef, where("userId", "==", userId));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const userDreams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Ordenar por fecha, los m√°s recientes primero
      userDreams.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
      setDreams(userDreams);
      setLoading(false);
    }, (error) => {
      console.error("Error al obtener sue√±os:", error);
      showMessageBox("Error al cargar tus sue√±os: " + error.message);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [db, userId, appId, showMessageBox]);

  const handleDeleteDream = async (dreamId) => {
    showMessageBox(
      "¬øEst√°s seguro de que quieres eliminar este sue√±o? Esta acci√≥n es irreversible.",
      async () => {
        try {
          const dreamDocRef = doc(db, `artifacts/${appId}/public/data/dreams`, dreamId);
          await deleteDoc(dreamDocRef);
          showMessageBox("Sue√±o eliminado con √©xito.");
        } catch (error) {
          console.error("Error al eliminar sue√±o:", error);
          showMessageBox("Error al eliminar sue√±o: " + error.message);
        }
      },
      () => setMessageBox({ message: '' }), // Cancelar acci√≥n
      true // Mostrar bot√≥n de cancelar
    );
  };

  const handleTogglePrivacy = async (dreamId, currentIsPublic) => {
    try {
      const dreamDocRef = doc(db, `artifacts/${appId}/public/data/dreams`, dreamId);
      await updateDoc(dreamDocRef, {
        isPublic: !currentIsPublic
      });
      showMessageBox("Privacidad del sue√±o actualizada.");
    } catch (error) {
      console.error("Error al actualizar privacidad:", error);
      showMessageBox("Error al actualizar privacidad: " + error.message);
    }
  };

  if (loading) {
    return <LoadingSpinner />;
  }

  return (
    <div className="bg-white p-8 rounded-xl shadow-2xl border border-purple-200 animate-fade-in">
      <h2 className="text-3xl font-bold text-purple-700 mb-8 text-center">Mis Sue√±os</h2>
      {dreams.length === 0 ? (
        <p className="text-gray-600 text-center text-lg py-10">A√∫n no has publicado ning√∫n sue√±o. ¬°An√≠mate a compartir el primero!</p>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {dreams.map((dream) => (
            <div key={dream.id} className="bg-purple-50 p-6 rounded-xl shadow-lg border border-purple-200 flex flex-col justify-between transform transition-transform duration-300 hover:scale-105 hover:shadow-xl">
              <div>
                <p className="text-sm text-gray-500 mb-3 flex items-center">
                  <span className="mr-2">üóìÔ∏è</span> {dream.timestamp ? new Date(dream.timestamp.toDate()).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Fecha desconocida'}
                </p>
                <h3 className="text-xl font-semibold text-gray-900 mb-3">{dream.title || "Sin t√≠tulo"}</h3> {/* Mostrar t√≠tulo */}
                <p className="text-lg font-medium text-gray-900 mb-4 italic">"{dream.content}"</p>
                <p className="text-md text-purple-700 mb-4 font-semibold flex items-center">
                  <span className="mr-2">üòä</span> Emoci√≥n: <span className="capitalize ml-1">{dream.emotion}</span>
                </p>
                {dream.tags && dream.tags.length > 0 && (
                  <div className="flex flex-wrap gap-2 mb-4">
                    {dream.tags.map(tag => (
                      <span key={tag} className="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                        #{tag}
                      </span>
                    ))}
                  </div>
                )}
                <p className="text-sm text-gray-600 mb-5 flex items-center">
                  {dream.isPublic ? <Eye className="w-4 h-4 mr-2 text-green-600" /> : <EyeOff className="w-4 h-4 mr-2 text-red-600" />}
                  Estado: <span className={`font-semibold ml-1 ${dream.isPublic ? 'text-green-600' : 'text-red-600'}`}>
                    {dream.isPublic ? 'P√∫blico' : 'Privado'}
                  </span>
                </p>
              </div>
              <div className="flex flex-wrap gap-3 mt-4">
                <button
                  onClick={() => handleTogglePrivacy(dream.id, dream.isPublic)}
                  className={`flex items-center space-x-1 px-4 py-2 text-sm rounded-full font-semibold transition duration-300 ease-in-out shadow-md ${
                    dream.isPublic ? 'bg-yellow-500 hover:bg-yellow-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'
                  }`}
                >
                  {dream.isPublic ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                  <span>{dream.isPublic ? 'Hacer Privado' : 'Hacer P√∫blico'}</span>
                </button>
                <button
                  onClick={() => handleDeleteDream(dream.id)}
                  className="flex items-center space-x-1 px-4 py-2 text-sm bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-300 ease-in-out shadow-md"
                >
                  <Trash2 className="w-4 h-4" />
                  <span>Eliminar</span>
                </button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// Componente para gestionar amigos
const Friends = () => {
  const { db, userId, showMessageBox, appId } = useContext(AppContext);
  const [friendIdInput, setFriendIdInput] = useState('');
  const [friends, setFriends] = useState([]);
  const [loading, setLoading] = useState(true);

  // Ruta de datos privada para la lista de amigos del usuario
  const userFriendsDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/friends`);

  useEffect(() => {
    if (!db || !userId) return;

    setLoading(true);
    const unsubscribe = onSnapshot(userFriendsDocRef, (docSnap) => {
      if (docSnap.exists()) {
        setFriends(docSnap.data().list || []);
      } else {
        setFriends([]);
      }
      setLoading(false);
    }, (error) => {
      console.error("Error al obtener amigos:", error);
      showMessageBox("Error al cargar amigos: " + error.message);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [db, userId, appId, showMessageBox]);

  const handleAddFriend = async (e) => {
    e.preventDefault();
    if (!friendIdInput.trim() || friendIdInput === userId) {
      showMessageBox("ID de amigo inv√°lido o es tu propio ID.");
      return;
    }

    // Verificar si el amigo ya est√° en la lista
    if (friends.includes(friendIdInput)) {
      showMessageBox("Este usuario ya es tu amigo.");
      return;
    }

    try {
      // Verificar si el ID de amigo existe como usuario en el sistema
      // Esto es una simplificaci√≥n; en una app real, podr√≠as tener un perfil de usuario para verificar
      // Por ahora, asumimos que cualquier ID de usuario v√°lido (no el propio) es aceptable.
      // En una aplicaci√≥n real, se deber√≠a verificar si el `friendIdInput` corresponde a un usuario existente.
      await setDoc(userFriendsDocRef, {
        list: arrayUnion(friendIdInput)
      }, { merge: true }); // Usar merge para no sobrescribir otros campos si los hubiera
      setFriendIdInput('');
      showMessageBox(`"${friendIdInput}" a√±adido como amigo.`);
    } catch (error) {
      console.error("Error al a√±adir amigo:", error);
      showMessageBox("Error al a√±adir amigo: " + error.message);
    }
  };

  const handleRemoveFriend = async (friendToRemove) => {
    showMessageBox(
      `¬øEst√°s seguro de que quieres eliminar a "${friendToRemove}" de tus amigos?`,
      async () => {
        try {
          await updateDoc(userFriendsDocRef, {
            list: arrayRemove(friendToRemove)
          });
          showMessageBox("Amigo eliminado con √©xito.");
        } catch (error) {
          console.error("Error al eliminar amigo:", error);
          showMessageBox("Error al eliminar amigo: " + error.message);
        }
      },
      () => setMessageBox({ message: '' }),
      true
    );
  };

  if (loading) {
    return <LoadingSpinner />;
  }

  return (
    <div className="bg-white p-8 rounded-xl shadow-2xl border border-purple-200 animate-fade-in">
      <h2 className="text-3xl font-bold text-purple-700 mb-8 text-center">Mis Amigos</h2>
      <form onSubmit={handleAddFriend} className="mb-8">
        <div className="flex flex-col sm:flex-row gap-4 items-center">
          <input
            type="text"
            className="shadow-inner appearance-none border border-gray-300 rounded-lg py-3 px-5 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-purple-300 flex-grow transition duration-200"
            placeholder="Introduce el ID de usuario de tu amigo"
            value={friendIdInput}
            onChange={(e) => setFriendIdInput(e.target.value)}
            required
          />
          <button
            type="submit"
            className="flex items-center space-x-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-300 ease-in-out transform hover:-translate-y-1"
          >
            <UserPlus className="w-5 h-5" />
            <span>A√±adir Amigo</span>
          </button>
        </div>
      </form>

      {friends.length === 0 ? (
        <p className="text-gray-600 text-center text-lg py-10">A√∫n no tienes amigos. ¬°A√±ade algunos para compartir sue√±os!</p>
      ) : (
        <div>
          <h3 className="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3 border-gray-200">Lista de Amigos:</h3>
          <ul className="space-y-4">
            {friends.map((friend) => (
              <li key={friend} className="flex justify-between items-center bg-purple-50 p-5 rounded-lg shadow-md border border-purple-200 transform transition-transform duration-300 hover:scale-[1.02] hover:shadow-lg">
                <span className="text-gray-800 font-medium text-lg">{friend}</span>
                <button
                  onClick={() => handleRemoveFriend(friend)}
                  className="flex items-center space-x-1 px-4 py-2 text-sm bg-red-500 text-white rounded-full hover:bg-red-600 transition duration-300 ease-in-out shadow-md"
                >
                  <Trash2 className="w-4 h-4" />
                  <span>Eliminar</span>
                </button>
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};

// Funci√≥n para limpiar texto y obtener palabras para la comparaci√≥n
const getCleanWords = (text) => {
  return text.toLowerCase().replace(/[.,!?;:()]/g, '').split(/\s+/).filter(word => word.length > 2);
};

// Componente para coincidencias de sue√±os
const Coincidences = () => {
  const { db, userId, showMessageBox, appId } = useContext(AppContext);
  const [publicDreams, setPublicDreams] = useState([]);
  const [myPublicDreams, setMyPublicDreams] = useState([]);
  const [coincidences, setCoincidences] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!db || !userId) return;

    setLoading(true);
    const dreamsCollectionRef = collection(db, `artifacts/${appId}/public/data/dreams`);

    // Obtener todos los sue√±os p√∫blicos
    const unsubscribeAllPublic = onSnapshot(query(dreamsCollectionRef, where("isPublic", "==", true)), (snapshot) => {
      const allPublic = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setPublicDreams(allPublic);
      setLoading(false);
    }, (error) => {
      console.error("Error al obtener sue√±os p√∫blicos:", error);
      showMessageBox("Error al cargar sue√±os p√∫blicos: " + error.message);
      setLoading(false);
    });

    // Obtener mis sue√±os p√∫blicos
    const unsubscribeMyPublic = onSnapshot(query(dreamsCollectionRef, where("userId", "==", userId), where("isPublic", "==", true)), (snapshot) => {
      const myPublic = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setMyPublicDreams(myPublic);
    }, (error) => {
      console.error("Error al obtener mis sue√±os p√∫blicos:", error);
      showMessageBox("Error al cargar mis sue√±os p√∫blicos: " + error.message);
    });

    return () => {
      unsubscribeAllPublic();
      unsubscribeMyPublic();
    };
  }, [db, userId, appId, showMessageBox]);

  useEffect(() => {
    if (myPublicDreams.length === 0 && publicDreams.length === 0) {
        setCoincidences([]);
        return;
    }

    const foundCoincidences = [];
    const processedDreamPairs = new Set(); // Para evitar duplicados (A-B es lo mismo que B-A)

    myPublicDreams.forEach(myDream => {
      const myDreamWords = new Set(getCleanWords(myDream.content));

      publicDreams.forEach(otherDream => {
        // No comparar un sue√±o consigo mismo ni con otros sue√±os del mismo usuario
        if (myDream.id === otherDream.id || myDream.userId === otherDream.userId) {
          return;
        }

        // Crear una clave √∫nica para el par de sue√±os para evitar duplicados
        const pairKey = [myDream.id, otherDream.id].sort().join('-');
        if (processedDreamPairs.has(pairKey)) {
          return;
        }

        const otherDreamWords = new Set(getCleanWords(otherDream.content));

        let commonWordsCount = 0;
        myDreamWords.forEach(word => {
          if (otherDreamWords.has(word)) {
            commonWordsCount++;
          }
        });

        // Calcular el porcentaje de palabras comunes
        const totalUniqueWords = new Set([...myDreamWords, ...otherDreamWords]).size;
        const similarity = totalUniqueWords > 0 ? (commonWordsCount / totalUniqueWords) * 100 : 0;

        // Definir un umbral de similitud (ej. 20% de palabras comunes)
        const SIMILARITY_THRESHOLD = 20;

        if (similarity >= SIMILARITY_THRESHOLD) {
          foundCoincidences.push({
            myDreamId: myDream.id,
            myDreamContent: myDream.content,
            myDreamTitle: myDream.title, // Incluir t√≠tulo del propio sue√±o
            otherDreamId: otherDream.id,
            otherDreamContent: otherDream.content,
            otherDreamTitle: otherDream.title, // Incluir t√≠tulo del otro sue√±o
            otherDreamUserId: otherDream.userId,
            similarity: similarity.toFixed(2)
          });
          processedDreamPairs.add(pairKey);
        }
      });
    });
    setCoincidences(foundCoincidences);
  }, [myPublicDreams, publicDreams]);

  if (loading) {
    return <LoadingSpinner />;
  }

  return (
    <div className="bg-white p-8 rounded-xl shadow-2xl border border-purple-200 animate-fade-in">
      <h2 className="text-3xl font-bold text-purple-700 mb-8 text-center">Coincidencias de Sue√±os</h2>
      {myPublicDreams.length === 0 ? (
        <p className="text-gray-600 text-center text-lg mb-6">Para encontrar coincidencias, primero necesitas publicar al menos un sue√±o como p√∫blico.</p>
      ) : (
        <p className="text-gray-600 text-center text-lg mb-6">Aqu√≠ ver√°s sue√±os p√∫blicos de otros usuarios que tienen similitudes con tus propios sue√±os p√∫blicos.</p>
      )}

      {coincidences.length === 0 ? (
        <p className="text-gray-600 text-center mt-6 text-lg py-10">No se encontraron coincidencias de sue√±os por ahora. ¬°Sigue so√±ando y publicando!</p>
      ) : (
        <div className="grid grid-cols-1 gap-8 mt-6">
          {coincidences.map((match, index) => (
            <div key={index} className="bg-blue-50 p-6 rounded-xl shadow-lg border border-blue-200 transform transition-transform duration-300 hover:scale-[1.02] hover:shadow-xl">
              <h3 className="text-xl font-semibold text-blue-700 mb-4 flex items-center">
                <Sparkles className="w-6 h-6 mr-2 text-blue-500" />
                Coincidencia Encontrada ({match.similarity}% similar)
              </h3>
              <div className="mb-4 p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
                <p className="text-gray-700 font-bold mb-2">Tu sue√±o: <span className="font-semibold">{match.myDreamTitle || "Sin t√≠tulo"}</span></p>
                <p className="text-gray-800 italic text-base">"{match.myDreamContent}"</p>
              </div>
              <div className="p-4 bg-white rounded-lg border border-gray-200 shadow-sm">
                <p className="text-gray-700 font-bold mb-2">Sue√±o de otro usuario (ID: <span className="font-mono">{match.otherDreamUserId.substring(0, 8)}...</span>): <span className="font-semibold">{match.otherDreamTitle || "Sin t√≠tulo"}</span></p>
                <p className="text-gray-800 italic text-base">"{match.otherDreamContent}"</p>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// Componente para el an√°lisis de sue√±os con IA
const AIDreamAnalysis = () => {
  const { db, userId, showMessageBox, appId } = useContext(AppContext);
  const [dreamText, setDreamText] = useState('');
  const [analysisResult, setAnalysisResult] = useState('');
  const [loading, setLoading] = useState(false);
  const [userDreams, setUserDreams] = useState([]);
  const [selectedDreamId, setSelectedDreamId] = useState('');

  useEffect(() => {
    if (!db || !userId) return;

    const dreamsCollectionRef = collection(db, `artifacts/${appId}/public/data/dreams`);
    const q = query(dreamsCollectionRef, where("userId", "==", userId));

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const dreams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setUserDreams(dreams);
    }, (error) => {
      console.error("Error al cargar sue√±os del usuario para IA:", error);
      showMessageBox("Error al cargar tus sue√±os para el an√°lisis IA: " + error.message);
    });

    return () => unsubscribe();
  }, [db, userId, appId, showMessageBox]);

  const handleAnalyzeDream = async () => {
    let textToAnalyze = dreamText.trim();
    if (selectedDreamId) {
      const selected = userDreams.find(d => d.id === selectedDreamId);
      if (selected) {
        textToAnalyze = selected.content;
      }
    }

    if (!textToAnalyze) {
      showMessageBox("Por favor, introduce un sue√±o o selecciona uno de tus sue√±os para analizar.");
      return;
    }

    setLoading(true);
    setAnalysisResult('');

    try {
      let chatHistory = [];
      const prompt = `Analiza el siguiente sue√±o y proporciona una interpretaci√≥n detallada de sus posibles significados, s√≠mbolos y emociones. Considera cualquier tema recurrente o elementos inusuales. Responde en espa√±ol.
      Sue√±o: "${textToAnalyze}"`;
      chatHistory.push({ role: "user", parts: [{ text: prompt }] });

      const payload = { contents: chatHistory };
      const apiKey = ""; // La clave API se proporciona en tiempo de ejecuci√≥n por Canvas
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        setAnalysisResult(text);
      } else {
        setAnalysisResult("No se pudo obtener un an√°lisis. Int√©ntalo de nuevo.");
        console.error("Respuesta inesperada de la IA:", result);
      }
    } catch (error) {
      console.error("Error al llamar a la API de IA:", error);
      setAnalysisResult("Error al conectar con la IA. Por favor, int√©ntalo de nuevo m√°s tarde.");
      showMessageBox("Error al analizar sue√±o con IA: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleSelectDream = (e) => {
    const id = e.target.value;
    setSelectedDreamId(id);
    if (id) {
      const selected = userDreams.find(d => d.id === id);
      if (selected) {
        setDreamText(selected.content);
      }
    } else {
      setDreamText('');
    }
  };

  return (
    <div className="bg-white p-8 rounded-xl shadow-2xl border border-purple-200 animate-fade-in">
      <h2 className="text-3xl font-bold text-purple-700 mb-8 text-center">An√°lisis de Sue√±os con IA</h2>

      <div className="mb-6">
        <label htmlFor="selectDream" className="block text-gray-700 text-lg font-semibold mb-2">
          Seleccionar un sue√±o existente:
        </label>
        <select
          id="selectDream"
          className="shadow-inner border border-gray-300 rounded-lg w-full py-3 px-5 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-200"
          value={selectedDreamId}
          onChange={handleSelectDream}
        >
          <option value="">-- O introduce uno nuevo --</option>
          {userDreams.map((dream) => (
            <option key={dream.id} value={dream.id}>
              {dream.title || dream.content.substring(0, 50)}... ({dream.timestamp ? new Date(dream.timestamp.toDate()).toLocaleDateString('es-ES') : 'Fecha desconocida'})
            </option>
          ))}
        </select>
      </div>

      <div className="mb-6">
        <label htmlFor="dreamText" className="block text-gray-700 text-lg font-semibold mb-2">
          O introduce un sue√±o para analizar:
        </label>
        <textarea
          id="dreamText"
          className="shadow-inner appearance-none border border-gray-300 rounded-lg w-full py-4 px-5 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-purple-300 h-48 resize-y transition duration-200"
          placeholder="Escribe el sue√±o que quieres que la IA analice en detalle..."
          value={dreamText}
          onChange={(e) => setDreamText(e.target.value)}
        ></textarea>
      </div>

      <button
        onClick={handleAnalyzeDream}
        className="flex items-center justify-center space-x-2 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-extrabold py-4 px-8 rounded-lg shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-75 transition duration-300 ease-in-out transform hover:-translate-y-1 w-full text-xl"
        disabled={loading}
      >
        <Brain className="w-6 h-6" />
        <span>{loading ? 'Analizando...' : 'Analizar Sue√±o con IA'}</span>
      </button>

      {loading && <LoadingSpinner />}

      {analysisResult && (
        <div className="mt-10 p-8 bg-blue-50 rounded-xl shadow-lg border border-blue-200 animate-fade-in-up">
          <h3 className="text-2xl font-bold text-blue-700 mb-5 flex items-center">
            <Sparkles className="w-6 h-6 mr-2 text-blue-500" />
            Resultado del An√°lisis de IA:
          </h3>
          <p className="text-gray-800 whitespace-pre-wrap leading-relaxed text-lg">{analysisResult}</p>
        </div>
      )}
    </div>
  );
};

export default App;
